name: iOS Tests

on:
  push:
    branches: [ main, 'copilot/**', 'feat/**', 'feature/**' ]
    paths:
      - 'ios/**'
      - 'shared/test-cards/**'
      - '.github/workflows/ios-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'shared/test-cards/**'
      - '.github/workflows/ios-tests.yml'

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Swift Version
      run: swift --version
      
    - name: Build iOS Package
      working-directory: ios
      run: swift build
      
    - name: Run Unit Tests
      working-directory: ios
      run: |
        swift test --parallel --enable-code-coverage \
          --filter "ACCoreTests|ACRenderingTests|ACInputsTests|ACTemplatingTests|ACMarkdownTests|ACChartsTests|IntegrationTests"
      
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-unit-test-results
        path: ios/.build/debug/
        retention-days: 7

  visual-tests:
    name: Visual Regression Tests
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Count test cards
      run: |
        CARD_COUNT=$(find shared/test-cards -name "*.json" | wc -l | tr -d ' ')
        echo "ðŸ“‹ Found $CARD_COUNT test card JSON files"
        echo "CARD_COUNT=$CARD_COUNT" >> $GITHUB_ENV

    - name: Run Visual Regression Tests (verify mode)
      working-directory: ios
      run: |
        swift test --filter "VisualTests" 2>&1 || true
      env:
        # Omit RECORD_SNAPSHOTS to run in comparison mode
        SNAPSHOT_TOLERANCE: "0.01"

    - name: Upload Snapshot Baselines
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-snapshot-baselines
        path: ios/Tests/VisualTests/Snapshots/Baselines/
        retention-days: 30

    - name: Upload Snapshot Failures
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-snapshot-failures
        path: |
          ios/Tests/VisualTests/Snapshots/Failures/
          ios/Tests/VisualTests/Snapshots/Diffs/
        retention-days: 14

    - name: Upload Visual Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-visual-reports
        path: ios/Tests/VisualTests/Snapshots/Reports/
        retention-days: 14

  parse-validation:
    name: Card Parse Validation
    runs-on: macos-14
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Validate all cards parse
      working-directory: ios
      run: |
        swift test --filter "AllCardsDiscoveryTests/testAllCards_parseOnly"
