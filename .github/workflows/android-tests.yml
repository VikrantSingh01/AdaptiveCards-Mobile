name: Android Tests

on:
  push:
    branches: [ main, 'copilot/**' ]
    paths:
      - 'android/**'
      - 'shared/test-cards/**'
      - '.github/workflows/android-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'android/**'
      - 'shared/test-cards/**'

permissions:
  contents: read

jobs:
  test:
    name: Run Android Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: Grant execute permission for gradlew
      working-directory: android
      run: chmod +x gradlew || echo "No gradlew found, using system gradle"
      
    - name: Run Android Tests
      working-directory: android
      run: |
        if [ -f gradlew ]; then
          ./gradlew test --stacktrace
        else
          gradle test --stacktrace
        fi
    
    - name: Run Snapshot Tests
      working-directory: android
      run: |
        if [ -f gradlew ]; then
          ./gradlew :ac-rendering:test --tests "*SnapshotTests" || echo "Snapshot tests not configured"
        fi
      
    - name: Run Android Lint
      working-directory: android
      run: |
        if [ -f gradlew ]; then
          ./gradlew lint || echo "Lint not configured"
        else
          gradle lint --stacktrace || echo "Lint not configured"
        fi
        
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-test-reports
        path: |
          android/**/build/reports/tests/
          android/**/build/test-results/
        retention-days: 7
