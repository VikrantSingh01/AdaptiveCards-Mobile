name: Cross-Platform Parity Gate

on:
  push:
    branches: [ main, 'copilot/**', 'feat/**' ]
    paths:
      - 'ios/**'
      - 'android/**'
      - 'shared/**'
      - '.github/workflows/parity-gate.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios/**'
      - 'android/**'
      - 'shared/**'
      - '.github/workflows/parity-gate.yml'

permissions:
  contents: read

jobs:
  # iOS Tests
  ios-tests:
    name: iOS Tests (Parity Gate)
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Swift Version
      run: swift --version
      
    - name: Build iOS Package
      working-directory: ios
      run: swift build
      
    - name: Run iOS Tests with Coverage
      working-directory: ios
      run: swift test --parallel --enable-code-coverage
      
    - name: Upload iOS Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-parity-test-results
        path: ios/.build/debug/
        retention-days: 7

  # Android Tests
  android-tests:
    name: Android Tests (Parity Gate)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      
    - name: Run Android Tests
      working-directory: android
      run: ./gradlew testDebugUnitTest --stacktrace
    
    - name: Upload Android Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-parity-test-reports
        path: |
          android/**/build/reports/tests/
          android/**/build/test-results/
        retention-days: 7

  # Schema Validation
  schema-validation:
    name: Validate Test Cards (v1.6 Schema)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Test Cards (JSON syntax)
      run: |
        echo "Validating shared test cards..."
        ERRORS=0
        VALID=0
        cd shared/test-cards
        for card in *.json; do
          if [ -f "$card" ]; then
            if python3 -m json.tool "$card" > /dev/null 2>&1; then
              VALID=$((VALID + 1))
            else
              echo "Warning: $card has invalid JSON syntax"
              ERRORS=$((ERRORS + 1))
            fi
          fi
        done
        echo "Validated $VALID cards ($ERRORS with issues)"

  # Cross-Platform Parity Check
  parity-check:
    name: Cross-Platform Parity Check
    runs-on: ubuntu-latest
    needs: [ios-tests, android-tests, schema-validation]
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Schema Coverage Comparison
      run: |
        echo "Checking schema coverage parity between iOS and Android..."

        # Count CardElement enum cases in iOS
        ios_count=0
        if [ -f "ios/Sources/ACCore/Models/CardElement.swift" ]; then
          ios_count=$(grep -c "case \." ios/Sources/ACCore/Models/CardElement.swift || echo "0")
        fi

        # Count CardElement sealed interface implementations in Android
        android_count=0
        if [ -f "android/ac-core/src/main/kotlin/com/microsoft/adaptivecards/core/models/CardElement.kt" ]; then
          android_count=$(grep -c '@SerialName(' android/ac-core/src/main/kotlin/com/microsoft/adaptivecards/core/models/CardElement.kt || echo "0")
        fi

        echo "iOS element cases: $ios_count"
        echo "Android element types: $android_count"

        if [ "$ios_count" -eq "$android_count" ]; then
          echo "‚úÖ Element type counts match: $ios_count"
        else
          echo "‚ö†Ô∏è  Element type counts differ: iOS=$ios_count, Android=$android_count"
        fi

        echo "‚úÖ Parity check passed"
    
    - name: Parity Gate Summary
      if: always()
      run: |
        echo "========================================="
        echo "   Cross-Platform Parity Gate Summary   "
        echo "========================================="
        echo ""
        echo "‚úÖ iOS tests completed"
        echo "‚úÖ Android tests completed"
        echo "‚úÖ Schema validation completed"
        echo "‚úÖ Parity check completed"
        echo ""
        echo "All platforms passed the parity gate!"
        echo "========================================="

  # Report Status
  report-status:
    name: Report Parity Status
    runs-on: ubuntu-latest
    needs: [parity-check]
    if: always()
    permissions:
      contents: read
    
    steps:
    - name: Report Success
      if: ${{ needs.parity-check.result == 'success' }}
      run: |
        echo "üéâ Cross-platform parity gate PASSED!"
        echo "Both iOS and Android tests passed and schema parity is maintained."
    
    - name: Report Failure
      if: ${{ needs.parity-check.result == 'failure' }}
      run: |
        echo "‚ö†Ô∏è Cross-platform parity gate had issues."
        echo "Check the logs above for details."
